# -*- coding: utf-8 -*-
"""streamlit_app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/192m1LeGZBqKU4rp81v9Ma6DY5YZ_coK1
"""

# üìò STREAMLIT WEB APP - CUSTOMER CHURN PREDICTION

import streamlit as st
import pandas as pd
import numpy as np
import joblib

# -------------------------------
# PAGE SETTINGS (keep this first)
# -------------------------------
st.set_page_config(page_title="Customer Churn Predictor", layout="wide")

# -------------------------------
# LOAD MODEL
# -------------------------------
@st.cache_resource
def load_model():
    # ‚úÖ Use forward slashes for Windows paths (avoids unicodeescape errors)
    model = joblib.load("C:/Users/lirda/OneDrive/Desktop/Projects/Churn Rate/processed/churn_best_model.pkl")
    return model

model = load_model()

# -------------------------------
# APP HEADER
# -------------------------------
st.title("üìâ Customer Churn Prediction System")
st.markdown(
    """
    Upload your customer dataset (CSV format) to predict churn probabilities in real time.
    This app uses your trained ML model to estimate customer churn risk and categorize it by severity.
    """
)
st.markdown("---")

# -------------------------------
# FILE UPLOAD
# -------------------------------
uploaded_file = st.file_uploader("üìÇ Upload your CSV file", type=["csv"])

if uploaded_file is not None:
    df = pd.read_csv(uploaded_file)
    st.success(f"‚úÖ File uploaded successfully: {uploaded_file.name}")
    st.write("### üìä Uploaded Data Preview")
    st.dataframe(df.head())

    # -------------------------------
    # DATA PREPROCESSING
    # -------------------------------
    if 'Churn' in df.columns:
        df.drop(columns=['Churn'], inplace=True)

    if 'tenure_group' in df.columns:
        df.drop(columns=['tenure_group'], inplace=True)

    # -------------------------------
    # PREDICTIONS
    # -------------------------------
    preds = model.predict_proba(df)[:, 1]
    df['Churn_Probability'] = preds

    # Risk categories
    df['Risk_Level'] = pd.cut(
        df['Churn_Probability'],
        bins=[-0.01, 0.3, 0.6, 0.8, 1.0],
        labels=['Low', 'Medium', 'High', 'Very High']
    )

    # -------------------------------
    # OUTPUT SECTION
    # -------------------------------
    st.markdown("### üîÆ Prediction Results")
    st.dataframe(df.head(20))

    # Download CSV
    csv = df.to_csv(index=False).encode('utf-8')
    st.download_button(
        "‚¨áÔ∏è Download Predictions CSV",
        csv,
        "churn_predictions.csv",
        "text/csv"
    )

    # Risk summary
    st.markdown("### üìä Risk Level Summary")
    st.bar_chart(df['Risk_Level'].value_counts())

    # Key metrics
    total_customers = len(df)
    high_risk = (df['Risk_Level'] == 'High').sum() + (df['Risk_Level'] == 'Very High').sum()
    st.metric("Total Customers", total_customers)
    st.metric("High Risk Customers", high_risk)

else:
    st.warning("üëÜ Please upload a valid customer dataset to start predictions.")

st.markdown("---")
st.caption("Built with ‚ù§Ô∏è using Streamlit, Scikit-learn, and XGBoost")