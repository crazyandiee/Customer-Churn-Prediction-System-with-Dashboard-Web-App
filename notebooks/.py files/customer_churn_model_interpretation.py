# -*- coding: utf-8 -*-
"""CUSTOMER_CHURN_MODEL_INTERPRETATION.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/github/crazyandiee/Customer-Churn-Prediction-System-with-Dashboard-Web-App/blob/main/notebooks/CUSTOMER_CHURN_MODEL_INTERPRETATION.ipynb
"""

import pandas as pd
import shap
import joblib
import matplotlib.pyplot as plt
import numpy as np

df = pd.read_csv("/content/telco_cleaned.csv")
model = joblib.load("/content/churn_best_model.pkl")

print("‚úÖ Data and Model Loaded Successfully!")
print("Data shape:", df.shape)
print("Model Type:", type(model))

# Separate features and target
X = df.drop(columns=["Churn", "tenure_group"])
y = df["Churn"]

# Detect model type and use appropriate SHAP explainer
if "xgboost" in str(type(model)).lower() or "forest" in str(type(model)).lower():
    print("\nüå≥ Using TreeExplainer (for XGBoost / RandomForest)")
    explainer = shap.TreeExplainer(model)
    shap_values = explainer(X)
elif "logistic" in str(type(model)).lower():
    print("\nüìà Using LinearExplainer (for Logistic Regression)")
    explainer = shap.LinearExplainer(model, X)
    shap_values = explainer.shap_values(X)
else:
    print("\n‚öôÔ∏è Using KernelExplainer (fallback, slower)")
    sample = shap.sample(X, 100)  # reduce computation
    explainer = shap.KernelExplainer(model.predict_proba, sample)
    shap_values = explainer.shap_values(X[:200])

#Global Feature Importance
try:
    print("\nüìä SHAP Summary Plot (Feature Importance)")
    shap.summary_plot(shap_values, X, plot_type="bar")
    plt.show()
except Exception as e:
    print("‚ö†Ô∏è Could not plot SHAP summary:", e)

#Detailed Feature Impact

try:
    shap.summary_plot(shap_values, X)
    plt.show()
except Exception as e:
    print("‚ö†Ô∏è Could not plot detailed summary:", e)

#Individual Prediction Explanation
sample_index = 42 #change this for different sample
print(f"\nüßç Explaining Customer #{sample_index}")

try:
    shap.waterfall_plot(shap.Explanation(values=shap_values[sample_index],
                                         base_values=getattr(explainer, 'expected_value', 0),
                                         feature_names=X.columns,
                                         data=X.iloc[sample_index]))
except Exception as e:
    print("‚ö†Ô∏è Could not generate waterfall plot:", e)

if isinstance(shap_values, list):  # handle linear explainer returning list
    sv = shap_values[0]
else:
    sv = shap_values.values if hasattr(shap_values, "values") else shap_values

shap_importance = pd.DataFrame({
    "feature": X.columns,
    "mean_abs_shap": np.abs(sv).mean(axis=0)
}).sort_values(by="mean_abs_shap", ascending=False)

print("\nüèÜ Top 10 Features Driving Churn:")
print(shap_importance.head(10))