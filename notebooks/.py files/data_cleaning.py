# -*- coding: utf-8 -*-
"""Data_Cleaning.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/github/crazyandiee/Customer-Churn-Prediction-System-with-Dashboard-Web-App/blob/main/notebooks/Data_Cleaning.ipynb
"""

import pandas as pd
import numpy as np

from google.colab import files
uploaded = files.upload()  # upload the CSV file manually

df=pd.read_csv('/content/Data/Raw/WA_Fn-UseC_-Telco-Customer-Churn.csv')

print("\n--- Basic Info ---")
print(df.info())
print("\n--- Missing Values ---")
print(df.isna().sum())
print("\n--- Sample Rows ---")
print(df.head(3))

# Clean Data Types
# 'TotalCharges' sometimes comes as string/object with blanks — convert to numeric
df['TotalCharges'] = pd.to_numeric(df['TotalCharges'], errors='coerce')

# Check how many were converted to NaN
print("\nMissing values in TotalCharges after conversion:", df['TotalCharges'].isna().sum())

# Fill missing TotalCharges with median (you can also use mean)
df['TotalCharges'] = df['TotalCharges'].fillna(df['TotalCharges'].median())

# Drop Irrelevant Columns
# 'customerID' is just an identifier
if 'customerID' in df.columns:
    df.drop(columns=['customerID'], inplace=True)

# Only map if Churn exists and not yet numeric
if df['Churn'].dtype == 'object':
    df['Churn'] = df['Churn'].map({'Yes': 1, 'No': 0})

# Feature Engineering

# tenure group (categorical bucket)
df['tenure_group'] = pd.cut(df['tenure'],
                            bins=[-1, 3, 12, 24, 60, np.inf],
                            labels=['0-3', '4-12', '13-24', '25-60', '60+'])

# count number of "Yes" services
service_cols = [
    'PhoneService','MultipleLines','OnlineSecurity','OnlineBackup',
    'DeviceProtection','TechSupport','StreamingTV','StreamingMovies'
]
df['num_services'] = df[service_cols].apply(lambda row: sum(row == 'Yes'), axis=1)

# payment method flag
df['is_electronic_payment'] = (df['PaymentMethod'] == 'Electronic check').astype(int)

# month-to-month contract flag
df['is_month_to_month'] = (df['Contract'] == 'Month-to-month').astype(int)

# average charge per month (guard against divide by zero)
df['avg_charge_per_month'] = df['TotalCharges'] / df['tenure'].replace(0, 1)

# Handle Categorical Variables
# Identify categorical columns (excluding target)
cat_cols = [col for col in df.select_dtypes(include='object').columns if col != 'Churn']

# One-hot encode categorical variables
df = pd.get_dummies(df, columns=cat_cols, drop_first=True)

print("\n✅ One-hot encoding complete. New shape:", df.shape)

# Final Checks
print("\nFinal Data Overview:")
print(df.info())
print("\n--- Sample of Clean Data ---")
print(df.head(5))

df.to_csv("/content/Data/Processed/telco_cleaned.csv", index=False)
print("✅ Clean dataset saved successfully!")